# Рекомендации с учётом спецификации систем

## Совместимость с Unix-подобными системами
Скрипты разработаны и оптимизированы для запуска в Unix-подобных системах. Проверьте наличие всех необходимых пакетов и утилит, которые могут быть специфичны для Unix систем.

## Подготовка сервера
Перед запуском на сервере проведите проверку всех сервисов и окружений, которые взаимодействуют со скриптами. Убедитесь, что права доступа и пути к файлам настроены корректно.

## Использование Cron для планирования
Для регулярного запуска скриптов используйте cron — систему планирования задач Unix. Настройте crontab для каждого скрипта, если требуется автоматическое выполнение задач.

# Документация для файла `main.py`

## Модули:
- `Pandas`: Используется для работы с данными в формате DataFrame и сохранения их в файл Excel.
- `Numpy`: Предназначен для выполнения математических операций с массивами и матрицами.
- `Shutil`: Предоставляет различные функции высокого уровня для работы с файлами и наборами файлов.
- `Selenium`: Инструмент для автоматизации действий веб-браузера.
- `Time`: Модуль, предоставляющий функции для работы с временем, например, для задержки выполнения кода.
- `Re`: Модуль, предназначенный для работы с регулярными выражениями.
- `Datetime`: Предоставляет классы для манипулирования датами и временем.
- `Subprocess`: Используется для запуска внешних процессов и команд.
- `Logging`: Используется для ведения журнала событий и ошибок.

## Константы:
- `EXCLUDE_INNS`: Список ИНН, которые следует исключить из обработки.
- `URL`: Веб-адрес для извлечения данных о компаниях.

## Функции:

### `extract_company_data(url)`
- **Описание**: Извлекает данные о компаниях с веб-страницы.
- **Параметры**:
  - `url` (str): URL веб-страницы для скрапинга.
- **Возвращает**:
  - `list`: Список словарей с данными о компаниях.

### `read_excel(file_name)`
- **Описание**: Читает данные из Excel файла.
- **Параметры**:
  - `file_name` (str): Имя файла Excel для чтения.
- **Возвращает**:
  - `DataFrame`: Данные из файла Excel в виде pandas DataFrame.

### `backup_old_version(file_name)`
- **Описание**: Создает резервную копию файла Excel.
- **Параметры**:
  - `file_name` (str): Имя файла Excel для создания резервной копии.

### `compare_and_update(companies)`
- **Описание**: Сравнивает новые данные с существующими и обновляет файл Excel.
- **Параметры**:
  - `companies` (DataFrame): DataFrame с данными о компаниях.

### `save_to_excel(companies, file_name)`
- **Описание**: Сохраняет данные в файл Excel, применяя форматирование.
- **Параметры**:
  - `companies` (DataFrame): Данные для сохранения.
  - `file_name` (str): Имя файла Excel для сохранения.

# Использование

Для запуска скрипта используйте команду:

```bash
python3.10 main.py
```
Убедитесь, что все зависимости установлены и файл `companies.xlsx` находится в нужном месте или будет создан при первом запуске скрипта.

## Примечания:
Убедитесь, что у вас установлены все необходимые библиотеки и драйверы для Selenium, а также что файлы, на которые ссылается код (например, драйвер ChromeDriver), доступны в системе.

# Логика работы файла `main.py`

1. **Импорт библиотек и настройка логирования:**
   - Импортируются необходимые модули для работы скрипта.
   - Настраивается логирование для отслеживания событий и потенциальных ошибок во время выполнения.

2. **Определение функций:**
   - `extract_company_data(url)`: Скрейпит данные о компаниях с указанного URL с использованием Selenium и Chrome в режиме без головы (headless). Элементы страницы и данные извлекаются на основе CSS-селекторов и регулярных выражений.
   - `read_excel(file_name)`: Читает файл Excel, содержащий информацию о компаниях, в DataFrame. Если файл не существует, возвращает пустой DataFrame.
   - `backup_old_version(file_name)`: Создает резервную копию существующего файла Excel, добавляя к его имени метку времени.
   - `log_changes(added)`: Записывает в лог-файл информацию о новых компаниях, добавленных в Excel файл.
   - `compare_and_update(companies)`: Сравнивает извлеченные данные с данными в существующем файле Excel. Исключает компании с определенными ИНН, обновляет существующие записи, добавляет новые и помечает их. Сохраняет обновленные данные в файл Excel.
   - `save_to_excel(companies, file_name)`: Сохраняет DataFrame в Excel файл, применяя цветовое форматирование к новым записям.

3. **Выполнение основного кода:**
   - Задается URL для скрейпинга данных.
   - Вызывается функция `extract_company_data(url)` для извлечения данных.
   - Полученные данные преобразуются в DataFrame.
   - Вызывается функция `compare_and_update(companies)` для сравнения и обновления файла Excel.

4. **Дополнительные скрипты:**
   - После выполнения основного скрипта запускаются дополнительные скрипты через модуль subprocess. 

5. **Заключение и чистка:**
   - После завершения основных операций скрипт завершает свою работу.

Эта последовательность шагов обеспечивает автоматизацию процесса сбора, обработки и сохранения данных о компаниях, а также их последующего анализа и распределения.

# Документация для файла `CHECK_STATUS.py`

## Модули:
- `openpyxl`: Для работы с файлами Excel, включая чтение и запись данных.
- `openpyxl.styles.PatternFill`: Для применения стилей (заливки) ячеек в Excel.
- `datetime`: Для работы с датой и временем, форматирование текущих меток времени.
- `dadata`: Клиент DaData для работы с информацией о компаниях (например, получение статуса компании по ИНН).
- `pandas`: Для обработки и анализа данных, создания DataFrame из изменений.
- `time`: Для введения задержки (ожидания) между попытками выполнения операций.
- `logging`: Для ведения логов операций, ошибок и изменений.

## Константы:
- `token`: Токен для аутентификации в API DaData.

## Функции:
### `extract_name_in_quotes(text, gosuslugi_name)`
- **Описание**: Извлекает название компании из текста, если текст содержит кавычки или специфические ключевые слова.
- **Параметры**:
  - `text (str)`: Строка текста, из которой необходимо извлечь название.
  - `gosuslugi_name (str)`: Название компании, полученное с сайта госуслуг.
- **Возвращает**: Название компании в кавычках или исходное название, если кавычки отсутствуют или текст содержит ключевые слова.

## Основной рабочий цикл:
- **Описание**: Периодически обновляет статусы компаний в Excel-файле на основе данных из API DaData. Если статус компании изменился, применяет красную заливку для выделения ячейки. В случае ошибки, записывает информацию в лог и пытается выполнить операцию заново после паузы.
- **Логика работы**:
  - Инициализация клиента DaData с токеном.
  - Загрузка Excel файла и чтение значений ИНН и текущих статусов компаний.
  - Запрос к API DaData для каждого ИНН с целью получения текущего статуса компании.
  - Сравнение нового статуса с текущим статусом в файле.
  - Если статус изменился, логирование изменения и применение красной заливки к соответствующим ячейкам Excel.
  - Обновление Excel файла с новым статусом и временной меткой.
  - В случае ошибки, логирование деталей ошибки и ожидание перед повторной попыткой.

## Логирование:
- Изменения статусов и возникшие ошибки записываются в файл `changes.log` с указанием времени события.

## Примечания:
- Для использования скрипта необходим установленный модуль `dadata` и доступ к API DaData.
- Важно обеспечить корректное форматирование файла Excel и наличие всех необходимых колонок перед запуском скрипта.
- Токен API DaData должен быть действительным и предоставлять доступ к нужным данным.
- Следует учитывать ограничения API DaData по количеству запросов в минуту, чтобы избежать блокировки.
- Логи и файл Excel должны быть доступны для записи скриптом.

# Логика работы файла `CHECK_STATUS.py`

1. **Инициализация API и стилей Excel:**
   - Скрипт начинает с инициализации клиента DaData, требующего валидный токен для запросов к API о данных компаний.
   - Создаётся объект для заливки ячеек в Excel, выделяющий компании с изменённым на неактивный статусом.

2. **Чтение Excel файла:**
   - Загружается Excel-файл с данными о компаниях.
   - С активного листа извлекаются данные ИНН и текущие статусы компаний.

3. **Получение и обновление данных:**
   - Для каждого ИНН выполняется запрос к API DaData для определения текущего статуса компании.
   - Статус переводится на русский язык и фиксируется текущее время как временная метка обновления.

4. **Сравнение и запись изменений:**
   - Сравнивается новый статус с имеющимся в файле.
   - Изменения записываются в лог и список изменений, к ячейкам с изменённым статусом применяется красная заливка.

5. **Обновление Excel файла:**
   - В файл вносятся обновлённые данные о статусах и временные метки.
   - Файл сохраняется с изменениями.

6. **Логирование:**
   - Изменения статусов фиксируются в файле `changes.log`.
   - Ошибки логируются с полной трассировкой.

7. **Управление ошибками:**
   - При возникновении ошибок они записываются в лог, после чего скрипт ждёт 5 секунд перед повторной попыткой.
   - Процесс повторения при ошибке продолжается до успешного завершения операции.

8. **Завершение работы скрипта:**
   - После обновления данных и записи изменений скрипт завершает работу.

Скрипт обеспечивает регулярное обновление данных о компаниях, автоматизируя сопоставление информации из внешнего источника с локальными данными, уменьшая ручную работу и риск человеческой ошибки.

# Документация для файла `YA_DISK.py`

## Модули
- `requests`: Отправка HTTP-запросов к API Яндекс.Диска.
- `openpyxl`: Взаимодействие с Excel файлами.
- `datetime`: Работа с датами и временем.
- `logging`: Ведение журнала событий.

## Константы
- `API_TOKEN`: Токен для аутентификации запросов к API Яндекс.Диска.
- `BASE_URL`: Базовый URL API Яндекс.Диска.

## Функции
### `get_folder_content(url, token)`
- **Описание**: Отправляет запрос к API и возвращает список файлов в папке.
- **Параметры**:
  - `url`: Ссылка на API для запроса содержимого папки.
  - `token`: Токен для авторизации запроса.

### `get_dates_from_folder(token, folder_path)`
- **Описание**: Извлекает даты из названий папок и сортирует их.
- **Параметры**:
  - `token`: Токен для доступа к API.
  - `folder_path`: Путь к папке.

## Логика работы `YA_DISK.py`
1. **Подготовка данных**:
   - Загрузка Excel файла `companies.xlsx`.
   - Создание объекта `sheet` для работы с активным листом Excel.

2. **Получение содержимого папки**:
   - Использование `get_dates_from_folder` для запроса содержимого папки Яндекс.Диска.

3. **Обработка данных**:
   - Итерация по строкам Excel, начиная со второй строки.
   - Формирование пути к папке на Яндекс.Диске из данных о компании.

4. **Запрос к API Яндекс.Диска**:
   - Получение информации о содержимом папки и датах изменений.

5. **Обновление Excel файла**:
   - Проверка и обновление дат последних изменений в файле.

6. **Логирование**:
   - Запись всех событий и изменений в лог-файл `changes.log`.

7. **Сохранение изменений**:
   - Сохранение обновлённых данных обратно в Excel файл.

8. **Обработка ошибок**:
   - Логирование ошибок и продолжение работы скрипта с следующей строки.

Скрипт предназначен для автоматического отслеживания изменений в данных о компаниях на Яндекс.Диске, что минимизирует необходимость ручного вмешательства и улучшает управление данными.

# Документация для файла `GOOGLE_SHEETS.py`

## Модули
- `pandas`: Работа с данными в формате DataFrame.
- `gspread`: Интерфейс для работы с Google Sheets.
- `oauth2client.service_account`: Аутентификация через Google API.
- `gspread_dataframe.set_with_dataframe`: Передача данных из DataFrame в Google Sheets.
- `gspread_formatting`: Форматирование ячеек в Google Sheets.
- `openpyxl.load_workbook`: Взаимодействие с Excel файлами.
- `logging`: Ведение журнала событий и ошибок.

## Константы
- `scopes`: Области действия для аутентификации через Google API.
- `creds`: Учетные данные после аутентификации для gspread клиента.

## Функции
- `ServiceAccountCredentials.from_json_keyfile_name`: Аутентификация в Google API.
- `gspread.authorize`: Авторизация клиента Google Sheets.
- `load_workbook`: Загрузка Excel файла.
- `fillna`: Замена NaN/бесконечных значений в DataFrame.
- `astype`: Преобразование типов данных в DataFrame.
- `set_with_dataframe`: Перенос данных в Google Sheets.
- `format_cell_range`: Форматирование диапазона ячеек.
- `CellFormat, Color, TextFormat, Borders, Border`: Классы для форматирования ячеек.

## Основной рабочий процесс
- Авторизация и доступ к Google Sheets.
- Загрузка, очистка и форматирование данных в Excel.
- Перенос данных из Excel в DataFrame, очистка и форматирование.
- Перенос отформатированных данных в Google Sheets.
- Применение форматирования в Google Sheets для визуализации.
- Логирование событий и ошибок.

## Логирование
- Запись операций и ошибок в `changes.log` с временными метками и важностью сообщений.

## Использование
- Требуется файл с учетными данными Google API в формате JSON.
- Файл Excel `companies.xlsx` должен быть доступен.
- Проверка `changes.log` после выполнения скрипта.

## Важные замечания
- Убедитесь, что Google Sheets и Drive API активны.
- Проверьте права сервисного аккаунта для чтения и записи в Google Sheets и Excel.

# Логика работы файла `GOOGLE_SHEETS.py`

1. **Настройка и Аутентификация:**
   - Определяет доступ к функциям Google Sheets API.
   - Аутентификация через сервисные аккаунты Google с JSON файлом учетных данных.

2. **Подключение к Google Sheets:**
   - Использование клиента gspread для открытия документа Google Sheets.
   - Выбор первого листа для выполнения операций.

3. **Обработка данных Excel:**
   - Загрузка и доступ к активному листу Excel файла `companies.xlsx`.
   - Очистка содержимого столбца в Excel, подготовка к обновлению.

4. **Обновление данных в Excel:**
   - Использование данных из Google Sheets для обновления Excel файла.
   - Сохранение обновленной информации в Excel.

5. **Чтение данных из Excel для обработки:**
   - Повторное чтение обновленных данных в DataFrame через pandas.
   - Преобразование столбцов в строки и замена NaN на пустые строки.

6. **Перенос данных из Excel в Google Sheets:**
   - Очистка Google Sheets перед обновлением.
   - Использование `set_with_dataframe` для переноса данных в Google Sheets.

7. **Форматирование данных в Google Sheets:**
   - Применение условного форматирования для подсветки статусов.
   - Улучшение читаемости через форматирование заголовков и границ.

8. **Логирование действий:**
   - Запись всех операций и ошибок в файл `changes.log`.

9. **Обработка ошибок:**
   - Логирование исключений с подробной информацией об ошибках.

10. **Завершение работы:**
    - Завершение работы скрипта после выполнения всех операций без ошибок.

**Примечание:** Для успешной работы требуются правильные доступы и активированные API в Google Developer Console, а также наличие и доступность файла `companies.xlsx`.
